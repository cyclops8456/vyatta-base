#!/bin/sh -e

# Author: Rick Balocca
# Date: 2007
# Description:

nothing_installed()
{
	PATTERN='\<0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.'
	grep "$PATTERN" /tmp/install$$ && grep "$PATTERN" /tmp/upgrade$$
}

nothing_upgraded()
{
	PATTERN='\<0 upgraded, 0 newly installed'
	grep "$PATTERN" /tmp/install$$ && grep "$PATTERN" /tmp/upgrade$$
}

df=noninteractive
export DEBIAN_FRONTEND="$df"

unattended=yes
netupgrade=-y
dontkeep=yes
download_only=yes

old_version=`grep '^Version' /opt/vyatta/etc/version|sed -e 's/.*[ 	]//'`
new_version=`apt-get --dry-run install vyatta-version|grep '^Inst'|sed -e 's/.*(//' -e 's/ .*//'`
case "$old_version" in 
[0-9]* )
	case "$new_version" in
	[vV]* )
		echo ERROR: attempting to upgrade from supported to community
		exit 1
		;;
	esac
	;;
* )
	case "$new_version" in
	[0-9]* | "" )
		apt-get -y remove vyatta-version
		;;
	esac
	;;
esac

# Find all vyatta packages to remove
echo "Vyatta full-upgrade status - Removing no longer needed dependencies"
apt-get $netupgrade -f autoremove #??
echo "Vyatta full-upgrade status - Fixing any broken depedencies"
apt-get -y -f install
echo "Vyatta full-upgrade status - Cleaning local repository of retrieved package files"
apt-get clean


required=400
free=`df /var/cache/apt/archives|tail -1|awk '{print $4}'`
free=`expr "$free" / 1000`
if [ "$free" -a "$free" -lt $required ]
then
	echo "$required Megabytes required for full upgrade, but only $free available."
	echo "Please free up more disk space and try again."
	exit 2
fi

echo "Vyatta full-upgrade status - Installing vyatta-version package"
apt-get install vyatta-version

#apt-cache dumpavail|grep '^Package.*vyatta' |grep -v '^Package.*linux-header'| sed 's/Package:  *//'|tr '\n' ' '>/tmp/$$ || true
#install_list=`cat /tmp/$$`

install_list=`awk '{print $1}' /opt/vyatta/etc/deb-versions.txt|tr '\n' ' '`

if [ ! "$install_list" ]
then
	echo "Version package not installed correctly.  Exiting."
	exit 1
fi

echo Downloading updates.  This may take a few minutes...
apt-get -y -f -d install $install_list | tee /tmp/install$$
apt-get -y -f -d dist-upgrade | tee /tmp/upgrade$$

if nothing_installed
then
	echo
	echo Nothing upgraded
	rm /tmp/install$$ /tmp/upgrade$$
	echo "Vyatta full-upgrade status - Cleaning local repository of retrieved package files"
	apt-get clean	# clean up the downloads in case we are close to full on root
	exit 1
fi

echo "Vyatta full-upgrade status - Download complete"
#rm -rf /tmp/install$$ /tmp/upgrade$$
