#!/bin/sh -e

# Author: Rick Balocca
# Date: 2007
# Description:

nothing_installed()
{
	PATTERN='\<0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.'
	grep "$PATTERN" /tmp/install$$ && grep "$PATTERN" /tmp/upgrade$$
}

nothing_upgraded()
{
	PATTERN='\<0 upgraded, 0 newly installed'
	grep "$PATTERN" /tmp/install$$ && grep "$PATTERN" /tmp/upgrade$$
}

prevent_start_on_install()
{
if [ -f /usr/sbin/policy-rc.d ]
 then
  # Save policy-rc.d file
  mv /usr/sbin/policy-rc.d /usr/sbin/policy-rc.d.orig
fi

# Create policy-rc.d file
cat > /usr/sbin/policy-rc.d << EOF
#!/bin/sh

echo
echo "PREVENT DAEMONS FROM STARTING DURING UPGRADE"

exit 101
EOF

chmod 0755 /usr/sbin/policy-rc.d
}

revert_to_default_policy()
{
if [ -f /usr/sbin/policy-rc.d.orig ]
 then
  # Restore policy-rc.d file
  mv /usr/sbin/policy-rc.d.orig /usr/sbin/policy-rc.d
 else
  # Remove policy-rc.d file
  rm -f /usr/sbin/policy-rc.d
fi
}

trap revert_to_default_policy INT TERM EXIT

df=noninteractive
unattended=yes
netupgrade=-y
dontkeep=yes
download_only=yes
export DEBIAN_FRONTEND="$df"
apt_args=" -y -f "

# Find all vyatta packages to remove
cd /tmp
sed '3icase "$1" in upgrade) exit 0;; esac' -i /var/lib/dpkg/info/vyatta-quagga.prerm 2>/dev/null || true

echo "Vyatta full-upgrade status - Configuring unpacked packages"
dpkg --configure -a
echo "Vyatta full-upgrade status - Fixing any broken depedencies"
apt-get $apt_args install
echo "Vyatta full-upgrade status - Removing no longer needed dependencies"
apt-get $apt_args autoremove

install_list=`awk '{print $1}' /opt/vyatta/etc/deb-versions.txt|tr '\n' ' '`
if [ ! "$install_list" ]
then
	echo "Version package not installed correctly.  Exiting."
	exit 1
fi

prevent_start_on_install
echo "Vyatta full-upgrade status - Install retrieved packages"
apt-get $apt_args install $install_list | tee /tmp/install$$
echo "Vyatta full-upgrade status - Upgrade packages and handle dependencies"
apt-get $apt_args dist-upgrade | tee /tmp/upgrade$$

if nothing_installed
then
	echo
	echo Nothing upgraded
	rm /tmp/install$$ /tmp/upgrade$$
	apt-get clean	# clean up the downloads in case we are close to full on root
	exit 1
fi

rm -rf /tmp/install$$ /tmp/upgrade$$
##############################################################

echo "Vyatta full-upgrade status - Installed packages from new version"

echo "Vyatta full-upgrade status - Removing no longer needed dependencies"
apt-get $apt_args autoremove
echo "Vyatta full-upgrade status - Cleaning local repository of retrieved package files"
apt-get clean	# remove the downloads in case we are close to full on root

##### use UUID instead of device for grub
root_dev=$(mount | grep ' on / type ' | cut -f 1 -d ' '|sed 's,/dev/,,')

if grep ide=nodma /boot/grub/menu.lst /boot/grub/grub.cfg >&/dev/null
then
	grub_options=ide=nodma
fi

echo "Vyatta full-upgrade status - Setting up grub"
/opt/vyatta/sbin/vyatta-grub-setup "$root_dev" "$grub_options" || echo WARNING: grub not completely setup.
echo "Vyatta full-upgrade status - Completed grub setup"
