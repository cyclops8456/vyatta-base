#!/bin/sh -e

# Author: Rick Balocca
# Date: 2007
# Description:

nothing_installed()
{
	PATTERN='\<0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.'
	grep "$PATTERN" /tmp/install$$ && grep "$PATTERN" /tmp/upgrade$$
}

nothing_upgraded()
{
	PATTERN='\<0 upgraded, 0 newly installed'
	grep "$PATTERN" /tmp/install$$ && grep "$PATTERN" /tmp/upgrade$$
}

df=noninteractive
unattended=yes
netupgrade=-y
dontkeep=yes
download_only=yes
export DEBIAN_FRONTEND="$df"
apt_args="$apt_args"

# Find all vyatta packages to remove
cd /tmp
sed '3icase "$1" in upgrade) exit 0;; esac' -i /var/lib/dpkg/info/vyatta-quagga.prerm 2>/dev/null || true

dpkg --configure -a
apt-get $apt_args install
apt-get $apt_args autoremove #??
apt-get $apt_args install

install_list=`awk '{print $1}' /opt/vyatta/etc/deb-versions.txt|tr '\n' ' '`
if [ ! "$install_list" ]
then
	echo "Version package not installed correctly.  Exiting."
	exit 1
fi

apt-get $apt_args install $install_list | tee /tmp/install$$
apt-get $apt_args dist-upgrade | tee /tmp/upgrade$$

if nothing_installed
then
	echo
	echo System already upgraded to newest packages
	rm /tmp/install$$ /tmp/upgrade$$
	apt-get $apt_args clean	# clean up the downloads in case we are close to full on root
	exit 0
fi

#rm -rf /tmp/install$$ /tmp/upgrade$$
#echo ====
#echo "$install_list"
##############################################################

apt-get $apt_args autoremove # ??
apt-get $apt_args clean	# remove the downloads in case we are close to full on root

# use UUID instead of device for grub
root_dev=$(mount | grep ' on / type ' | cut -f 1 -d ' ')
if grep -q ide=nodma /boot/grub/menu.lst /boot/grub/grub.cfg
then
	grub_options=ide=nodma
fi

/opt/vyatta/sbin/grub-setup "$root_dev" "$grub_options" || echo WARNING: grub not completely setup.

(   [ -s /boot/grub/menu.lst ] &&
	upgrade-from-grub-legacy &&
	rm -f /boot/grub/menu.lst*
) || true

# if we are upgrading from the net, don't bother asking the reboot question...
#[ "$netupgrade" ] && reboot

echo You need to reboot the system to complete the upgrade
echo -n "Reboot now? "
read j
case "$j" in
y|Y|[yY][eE][sS] )
	reboot;;
esac
