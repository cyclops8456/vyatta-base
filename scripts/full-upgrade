#!/bin/sh

# Author: Rick Balocca
# Date: 2007
# Description:

PATH=/opt/vyatta/bin:$PATH

usage()
{
cat <<EOF
$0 must be run with one of the following options:
  -h : Print help ( this help text )
  -k : Keep all packages not part of the target Vyatta version.
       Due to package dependencies some user added packages may not
        function properly.
  -i : The user will be prompted to answer all questions generated by
        packages during the upgrade.
EOF
}

cd /tmp

OPTION="$1"
[ "$OPTION" ] || OPTION=`ps l|grep 'full-upgrade -'|sed 's,.*full-upgrade ,,'`
case "$OPTION" in
 -i )
	download-only "$OPTION" || exit $?
	/opt/vyatta/bin/_full-upgrade $OPTION
	;;

 -k  )
	download-only "$OPTION" || exit $?
	if ! mkdir full-upgrade.lock
	then
		echo "full-upgrade can't acquire it's lock file (/tmp/full-upgrade.lock )."
		echo "You may be attempting to run full-upgrade more than once simultaneously."
		echo "If you want to proceed, then first rm -rf /tmp/full-upgrade.lock ."
		exit 1
	fi
	echo "Please wait.  Now entering unattended mode."
	echo "This will take a long time.  When done,"
	echo "the system will automatically reboot."
	hupfile=/root/nohup$$.out
	rm /root/full-upgrade*
	>/root/full-upgrade.log
	ln -s /root/full-upgrade.log /root/full-upgrade$$.log
	tail -f /root/full-upgrade$$.log&
	nohup /opt/vyatta/bin/_full-upgrade $OPTION>&$hupfile
	sleep 10
	cat /root/nohup$$.out
	rm -rf full-upgrade.lock
	;;

 * )
	usage
	exit
esac
